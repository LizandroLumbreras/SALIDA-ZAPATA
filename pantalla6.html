<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(to right, #00416A, #E4E5E6); color: white; padding: 20px; }
    .firmas-vertical { display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
    .firmas-vertical img { width: 100%; max-width: 240px; height: auto; background: white; border-radius: 5px; }
    .resumen { background: white; border-radius: 10px; padding: 20px; max-width: 800px; margin: auto; color: black; }
    h2 { text-align: center; margin-bottom: 20px; }
    .firmas { display: flex; justify-content: space-between; margin-top: 30px; }
    .firmas div { width: 45%; text-align: center; }
    .firmas img { max-width: 100%; height: 100px; background: white; border-radius: 5px; }
    ul { list-style: none; padding: 0; margin: 10px 0; }
    li { margin-bottom: 10px; background: white; color: black; padding: 10px; border-radius: 5px; }
    button { display: block; margin: 30px auto 0; padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; background: green; color: white; cursor: pointer; }
    @media print {
      body { margin-top: 15px; margin-bottom: 15px; color: black !important; background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-size: 14px; }
      .resumen { width: 280px; margin: auto; padding: 5px 10px; font-size: 18px; background: white; color: black; }
      .resumen * { color: black !important; background: none !important; }
      .resumen h2 { margin-top: 10px; font-size: 15px; text-align: center; }
      ul { padding-left: 10px; }
      img { max-width: 100%; height: auto; filter: contrast(150%); }
      .firmas-vertical { display: flex; flex-direction: column; align-items: center; margin-top: 20px; font-size: 12px; }
      .firmas-vertical div { margin-bottom: 20px; width: 100%; text-align: center; }
      .firmas-vertical img { width: 90%; max-width: 250px; height: 60px; border: 1px solid #000; border-radius: 4px; filter: contrast(180%) brightness(1.2); }
      button, .no-print { display: none !important; }
    }
  </style>
</head>
<body>

  <div class="resumen">
    <h2>üìã Resumen de salida</h2>
    <p><strong>Folio:</strong> <span id="folio">Cargando...</span></p>
    <p><strong>Fecha:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <h3>üõí Art√≠culos:</h3>
    <ul id="lista-articulos"></ul>

    <div class="firmas-vertical">
      <div>
        <p>Firma quien entrega</p>
        <img id="firmaEntrega" src="" alt="Firma entrega">
      </div>
      <div style="margin-top: 30px;">
        <p>Firma quien recibe</p>
        <img id="firmaRecibe" src="" alt="Firma recibe">
      </div>
    </div>

    <button class="no-print" onclick="imprimirYDescargar()" style="background-color:#28a745;">üñ®Ô∏è Imprimir y Descargar</button>
    <button class="no-print" onclick="guardarEnFirebase()" style="background-color:#007bff;">üíæ Guardar salida</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // ‚ö†Ô∏è Ideal mover este env√≠o a backend para no exponer el token
    async function notificarLobaZapata(salida) {
      try {
        const token = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
        const chatId = "6617988297";

        let mensaje = `üö® Nueva salida registrada en Almac√©n Zapata\n\n`;
        mensaje += `üìÑ Folio: ${salida.folio}\n`;
        mensaje += `üìÖ Fecha: ${salida.fecha}\n`;
        mensaje += `üë§ Entrega: ${salida.entrega}\n`;
        mensaje += `ü§ù Recibe: ${salida.recibe}\n`;
        mensaje += `üìç Destino: ${salida.destino}\n\n`;

        if (Array.isArray(salida.articulos) && salida.articulos.length > 0) {
          mensaje += `üì¶ Art√≠culos:\n`;
          salida.articulos.forEach(p => {
            mensaje += `‚Ä¢ ${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})\n`;
          });
        } else {
          mensaje += `‚ö†Ô∏è No hay art√≠culos registrados.\n`;
        }

        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: chatId,
            text: mensaje
            // parse_mode: "Markdown"  // opcional; mejor evitar si hay guiones bajos en c√≥digos
          })
        });
      } catch (e) {
        console.warn("No se pudo notificar por Telegram (continuando):", e);
      }
    }
  </script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com", /* m√°s com√∫n */
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let folio = "";
    let numeroFolio = 0;

    async function obtenerFolioDesdeFirebase() {
      const ref = db.collection("consecutivos").doc("salidas_zapata");
      const snap = await ref.get();
      // Muestra el SIGUIENTE n√∫mero disponible
      numeroFolio = (snap.exists ? (snap.data().ultimo || 0) : 0) + 1;
      folio = "PDDZAP - " + String(numeroFolio).padStart(4, "0");
      document.getElementById("folio").textContent = folio;
    }

  function imprimirYDescargar() {
    const elemento = document.querySelector(".resumen");
    const originalBackground = elemento.style.background;
    elemento.style.background = "white"; // asegura fondo blanco

    html2canvas(elemento, { scale: 2 }).then(canvas => {
      const link = document.createElement("a");
      link.download = `${document.getElementById("folio").textContent || "salida"}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();

      // Aqu√≠ s√≠ imprime
      setTimeout(() => {
        window.print();
        elemento.style.background = originalBackground; // restaurar
      }, 500);
    });
  }

async function guardarEnFirebase() {
  await obtenerFolioDesdeFirebase(); // Asegura folio actualizado

  const fecha = localStorage.getItem("resumenFecha") || localStorage.getItem("fecha") || new Date().toLocaleString("es-MX");
  const entrega = localStorage.getItem("entrega") || "";
  const recibe = localStorage.getItem("recibe") || "";
  const destino = localStorage.getItem("destino") || "";
  const firmaEntrega = localStorage.getItem("firmaEntrega") || "";
  const firmaRecibe = localStorage.getItem("firmaRecibe") || "";
  const articulos = JSON.parse(localStorage.getItem("carrito") || "[]");

  const salida = {
    folio, fecha, entrega, recibe, destino, firmaEntrega, firmaRecibe, articulos,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    // Guarda la salida normal
    await db.collection("almacenes").doc("almacen_zapata").collection("salidas").add(salida);

    // Incrementa consecutivo
    await db.collection("consecutivos").doc("salidas_zapata").update({
      ultimo: firebase.firestore.FieldValue.increment(1)
    });

    // === üîç BLOQUE DE VERIFICACI√ìN DE INVENTARIO ===
    const token = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
    const chatId = "6617988297";

    for (const art of articulos) {
      try {
        const q = await db.collection("seguimiento_inventario")
          .where("codigo", "==", art.codigo)
          .get();

        if (!q.empty) {
          q.forEach(async (docu) => {
            const data = docu.data();
            const ref = db.collection("seguimiento_inventario").doc(docu.id);
            const nuevaExistencia = (data.existencia_actual || 0) - art.cantidad;

            await ref.update({
              existencia_actual: nuevaExistencia,
              ultima_salida: new Date().toISOString()
            });

            // Siempre manda mensaje ‚Äî verde o rojo
            const estado = nuevaExistencia <= data.alerta_minima ? "‚ö†Ô∏è *BAJO STOCK*" : "‚úÖ *Stock actualizado*";
            const mensaje = `
${estado}
üì¶ ${data.descripcion || art.nombre}
üÜî C√≥digo: ${art.codigo}
üè† Almac√©n: Zapata
üìâ Existencia actual: ${nuevaExistencia}
üî¢ M√≠nimo definido: ${data.alerta_minima}
üìÖ Fecha: ${new Date().toLocaleString("es-MX")}
            `;

            await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                chat_id: chatId,
                text: mensaje,
                parse_mode: "Markdown"
              })
            });
          });
        }
      } catch (err) {
        console.error("Error en seguimiento:", err);
      }
    }
    // ===============================================

    // Notifica salida general (la que ya ten√≠as)
    await notificarLobaZapata(salida);

    // Limpia localStorage
    ["carrito","firmaEntrega","firmaRecibe","fecha","resumenFecha","entrega","recibe","destino"]
      .forEach(k => localStorage.removeItem(k));

    alert("‚úÖ Salida guardada correctamente.");
    window.location.href = "./index.html";

  } catch (error) {
    console.error("Error al guardar:", error);
    alert("‚ùå Error al guardar la salida.");
  }
}
    document.addEventListener("DOMContentLoaded", async () => {
      await obtenerFolioDesdeFirebase();

      document.getElementById('fecha').textContent   = localStorage.getItem("resumenFecha") || "Sin fecha";
      document.getElementById('entrega').textContent = localStorage.getItem("entrega") || "No asignado";
      document.getElementById('recibe').textContent  = localStorage.getItem("recibe") || "No asignado";
      document.getElementById('destino').textContent = localStorage.getItem("destino") || "NO DEFINIDO";
      document.getElementById('firmaEntrega').src    = localStorage.getItem("firmaEntrega") || "";
      document.getElementById('firmaRecibe').src     = localStorage.getItem("firmaRecibe") || "";

      const lista = JSON.parse(localStorage.getItem("carrito") || "[]");
      const ul = document.getElementById("lista-articulos");
      lista.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `‚Ä¢ ${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})`;
        ul.appendChild(li);
      });
    });
  </script>

  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>


