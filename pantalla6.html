<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(to right, #00416A, #E4E5E6); color: white; padding: 20px; }
    .firmas-vertical { display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
    .firmas-vertical img { width: 100%; max-width: 240px; height: auto; background: white; border-radius: 5px; }

    .resumen { background: white; border-radius: 10px; padding: 20px; max-width: 800px; margin: auto; color: black; }
    h2 { text-align: center; margin-bottom: 20px; }

    ul { list-style: none; padding: 0; margin: 10px 0; }
    li { margin-bottom: 10px; background: white; color: black; padding: 10px; border-radius: 5px; }

    button { display: block; margin: 30px auto 0; padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer; }
    button[disabled] { opacity: .7; cursor: not-allowed; }

    @media print {
      body { margin-top: 15px; margin-bottom: 15px; color: black !important; background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; font-size: 14px; }
      .resumen { width: 280px; margin: auto; padding: 5px 10px; font-size: 18px; background: white; color: black; }
      .resumen * { color: black !important; background: none !important; }
      .resumen h2 { margin-top: 10px; font-size: 15px; text-align: center; }
      ul { padding-left: 10px; }
      img { max-width: 100%; height: auto; filter: contrast(150%); }
      .firmas-vertical { display: flex; flex-direction: column; align-items: center; margin-top: 20px; font-size: 12px; }
      .firmas-vertical div { margin-bottom: 20px; width: 100%; text-align: center; }
      .firmas-vertical img { width: 90%; max-width: 250px; height: 60px; border: 1px solid #000; border-radius: 4px; filter: contrast(180%) brightness(1.2); }
      button, .no-print { display: none !important; }
    }
  </style>
</head>
<body>

  <div class="resumen" id="resumen">
    <h2>üìã Resumen de salida</h2>
    <p><strong>Folio:</strong> <span id="folio">Cargando...</span></p>
    <p><strong>Fecha:</strong> <span id="fecha">‚Äî</span></p>
    <p><strong>Entrega:</strong> <span id="entrega">‚Äî</span></p>
    <p><strong>Recibe:</strong> <span id="recibe">‚Äî</span></p>
    <p><strong>Destino:</strong> <span id="destino">‚Äî</span></p>

    <h3>üõí Art√≠culos:</h3>
    <ul id="lista-articulos"></ul>

    <div class="firmas-vertical">
      <div>
        <p>Firma quien entrega</p>
        <img id="firmaEntrega" src="" alt="Firma entrega">
      </div>
      <div style="margin-top: 30px;">
        <p>Firma quien recibe</p>
        <img id="firmaRecibe" src="" alt="Firma recibe">
      </div>
    </div>
  </div>

  <!-- √öNICO BOT√ìN -->
  <button id="btn-unico" class="no-print" onclick="guardarDescargarImprimir()">üíæüñ®Ô∏è Guardar, descargar e imprimir</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // ============ Helpers ============
    const L = {
      get: (k, fallback = "") => {
        const v = localStorage.getItem(k);
        if (v !== null && v !== undefined && v !== "") return v;
        const s = sessionStorage.getItem(k);
        return (s !== null && s !== undefined && s !== "") ? s : fallback;
      },
      getJSON: (k) => {
        try {
          const v = localStorage.getItem(k) ?? sessionStorage.getItem(k);
          return v ? JSON.parse(v) : null;
        } catch { return null; }
      },
      delMany: (arr) => arr.forEach(k => { localStorage.removeItem(k); sessionStorage.removeItem(k); })
    };

    // ‚ö†Ô∏è Ideal mover a backend para no exponer token
    async function notificarLobaZapata(salida) {
      try {
        const token = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
        const chatId = "6617988297";
        let mensaje = `üö® Nueva salida registrada en Almac√©n Zapata\n\n`;
        mensaje += `üìÑ Folio: ${salida.folio}\n`;
        mensaje += `üìÖ Fecha: ${salida.fecha}\n`;
        mensaje += `üë§ Entrega: ${salida.entrega}\n`;
        mensaje += `ü§ù Recibe: ${salida.recibe}\n`;
        mensaje += `üìç Destino: ${salida.destino}\n\n`;
        if (Array.isArray(salida.articulos) && salida.articulos.length > 0) {
          mensaje += `üì¶ Art√≠culos:\n`;
          salida.articulos.forEach(p => { mensaje += `‚Ä¢ ${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})\n`; });
        } else {
          mensaje += `‚ö†Ô∏è No hay art√≠culos registrados.\n`;
        }
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ chat_id: chatId, text: mensaje })
        });
      } catch (e) { console.warn("No se pudo notificar por Telegram:", e); }
    }

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let folio = "PDDZAP - PENDIENTE";

    // Solo vista previa del siguiente folio (no bloquea)
    async function previsualizarProximoFolio() {
      try {
        const ref = db.collection("consecutivos").doc("salidas_zapata");
        const snap = await ref.get();
        const next = (snap.exists ? Number(snap.data().ultimo) || 0 : 0) + 1;
        folio = "PDDZAP - " + String(next).padStart(4, "0");
      } catch (e) {
        console.warn("No se pudo leer folio (muestra PENDIENTE).", e);
        folio = "PDDZAP - PENDIENTE";
      } finally {
        document.getElementById("folio").textContent = folio;
      }
    }

    // Bloquea y genera folio con transacci√≥n
    async function generarFolioTransaccion() {
      const ref = db.collection("consecutivos").doc("salidas_zapata");
      const next = await db.runTransaction(async (tx) => {
        const doc = await tx.get(ref);
        const ultimo = doc.exists ? (Number(doc.data().ultimo) || 0) : 0;
        const siguiente = ultimo + 1;
        tx.set(ref, { ultimo: siguiente }, { merge: true });
        return siguiente;
      });
      return "PDDZAP - " + String(next).padStart(4, "0");
    }

    async function descargarPNGyImprimir(nombreArchivo = "salida") {
      const elemento = document.getElementById("resumen");
      const originalBg = elemento.style.background;
      elemento.style.background = "white";
      const canvas = await html2canvas(elemento, { scale: 2, backgroundColor: "#ffffff" });
      const link = document.createElement("a");
      link.download = `${nombreArchivo}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      setTimeout(() => { window.print(); elemento.style.background = originalBg; }, 400);
    }

    async function guardarDescargarImprimir() {
      const btn = document.getElementById("btn-unico");
      btn.disabled = true; const oldText = btn.textContent; btn.textContent = "Procesando...";

      try {
        // 0) Cargar art√≠culos desde storage
        const articulos = L.getJSON("carrito") || [];
        if (!Array.isArray(articulos) || articulos.length === 0) {
          alert("‚ö†Ô∏è No hay art√≠culos en el resumen. Vuelve a la pantalla anterior y agrega productos.");
          return;
        }

        // 1) Folio con transacci√≥n
        folio = await generarFolioTransaccion();
        document.getElementById("folio").textContent = folio;

        // 2) Datos
        const fecha = L.get("resumenFecha", L.get("fecha", new Date().toLocaleString("es-MX")));
        const salida = {
          folio,
          fecha,
          entrega: L.get("entrega", ""),
          recibe:  L.get("recibe",  ""),
          destino: L.get("destino", "NO DEFINIDO"),
          firmaEntrega: L.get("firmaEntrega", ""),
          firmaRecibe:  L.get("firmaRecibe",  ""),
          articulos,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // 3) Guardar
        await db.collection("almacenes").doc("almacen_zapata").collection("salidas").add(salida);

        // 4) Descargar PNG e imprimir
        await descargarPNGyImprimir(folio);

        // 5) Notificar (no bloquea)
        notificarLobaZapata(salida);

        // 6) Limpia y redirige
        L.delMany(["carrito","firmaEntrega","firmaRecibe","fecha","resumenFecha","entrega","recibe","destino"]);
        setTimeout(() => {
          alert("‚úÖ Salida guardada, descargada e impresa correctamente.");
          window.location.href = "./index.html";
        }, 2500);

      } catch (error) {
        console.error("Error en el proceso:", error);
        alert("‚ùå Ocurri√≥ un error al guardar/imprimir. Revisa la consola.");
      } finally {
        btn.disabled = false; btn.textContent = oldText;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await previsualizarProximoFolio();

      // Carga segura de datos (desde localStorage o sessionStorage)
      const fechaTxt = L.get("resumenFecha", L.get("fecha", "Sin fecha"));
      document.getElementById('fecha').textContent   = fechaTxt;
      document.getElementById('entrega').textContent = L.get("entrega", "No asignado");
      document.getElementById('recibe').textContent  = L.get("recibe",  "No asignado");
      document.getElementById('destino').textContent = L.get("destino", "NO DEFINIDO");
      document.getElementById('firmaEntrega').src    = L.get("firmaEntrega", "");
      document.getElementById('firmaRecibe').src     = L.get("firmaRecibe",  "");

      const lista = L.getJSON("carrito") || [];
      const ul = document.getElementById("lista-articulos");
      ul.innerHTML = "";
      if (!Array.isArray(lista) || lista.length === 0) {
        const li = document.createElement("li");
        li.textContent = "‚Äî Sin art√≠culos agregados ‚Äî";
        ul.appendChild(li);
      } else {
        lista.forEach(p => {
          const li = document.createElement("li");
          li.textContent = `‚Ä¢ ${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})`;
          ul.appendChild(li);
        });
      }
    });
  </script>
</body>
</html>
